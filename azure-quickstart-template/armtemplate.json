{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "appName": {
            "type": "string",
            "defaultValue": "[concat('strapi', uniqueString(resourceGroup().id), '-app')]",
            "metadata": {
                "description": "Name of the App Service"
            }
        },
        "databaseClient": {
            "type": "string",
            "defaultValue": "postgres",
            "allowedValues": [
                "mysql",
                "postgres"
            ],
            "metadata": {
                "description": "Type of database server to use. Currently, PostgreSQL and MySQL are supported"
            }
        },
        "databaseAdminUsername": {
            "type": "string",
            "metadata": {
                "description": "Username used to connect to the Strapi Database Server"
            }
        },
        "databaseAdminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "Password used to connect to the Database Server"
            }
        },
        "storageAccountPublicAccessEnabled": {
            "type": "bool",
            "defaultValue": false,
            "metadata": {
                "description": "Enable or disable public access to the storage account blob container"
            }
        },
        "emailDataLocation":{
            "type": "string",
            "defaultValue": "United States",
            "allowedValues": [
                "Africa",
                "Asia Pacific",
                "Australia",
                "Brazil",
                "Canada",
                "Europe",
                "France",
                "Germany",
                "India",
                "Japan",
                "Korea",
                "Norway",
                "Switzerland",
                "United Arab Emirates",
                "United Kingdom",
                "United States"
            ],
            "metadata": {
                "description": "Location for the email data. Choose a location that best fits your compliance and data residency requirements."
            }
        },
        "applicationMode": {
            "type": "string",
            "defaultValue": "development",
            "allowedValues": [
                "development",
                "production"
            ],
            "metadata": {
                "description": "Type of environment for Strapi. Setting it to production disables edit controls for the content type builder. For production use, always set it to production."
            }
        },
        "appKeys": {
            "type": "securestring",
            "metadata": {
                "description": "A comma separated list of secret keys (strings) to sign the session cookies. Used by Strapi's session middleware."
            }
        },
        "jwtSecret": {
            "type": "securestring",
            "metadata": {
                "description": "The secret used to sign the JWT for Strapi's Users-Permissions plugin."
            }
        },
        "adminJwtSecret": {
            "type": "securestring",
            "metadata": {
                "description": "The secret used to sign the JWT for the Strapi Admin panel."
            }
        },
        "apiTokenSalt": {
            "type": "securestring",
            "metadata": {
                "description": "Salt used to generate tokens for Strapi APIs. If not defined, authenticated API features may not work correctly."
            }
        },
        "transferTokenSalt": {
            "type": "securestring",
            "metadata": {
                "description": "Salt used to generate transfer tokens for Strapi data transfer between instances. If not defined, transfer features will be disabled."
            }
        }
    },
    "variables": {
        "location": "[resourceGroup().location]",
        "appNameShortened": "[take(replace(parameters('appName'),'-',''), 9)]",
        "uniqueNameSuffix": "[concat(variables('appNameShortened'), '-', uniqueString(parameters('appName'), resourceGroup().id))]",
        "hostingPlanName": "[concat('asp-', variables('uniqueNameSuffix'))]",
        "tags": { 
            "AppProfile": "Strapi" 
        },
        "artifactLocation": "https://github.com/Azure-Samples/strapi-on-appservice-sample/raw/refs/heads/main/strapi-packages/strapi-on-appservice-demo.zip",
        "startupCommand": "[if(equals(toLower(parameters('applicationMode')),'development'), 'npm run develop', '')]",
        "containerStartTimeLimit": "900",
        "scmDoBuildDuringDeployment": true,
        "autoGeneratedDomainNameLabelScope": "TenantReuse",

        "isAppInProdMode": "[equals(toLower(parameters('applicationMode')), 'production')]",
        "numberOfWorkers": 1,
        "linuxFxVersion": "NODE|22-lts",
        "skuName": "[if(variables('isAppInProdMode'), 'P1V3', 'P0V3')]",
        "skuTier": "PremiumV3",
        "publicNetworkAccess": "Enabled",
        "websitePort": 1337,
        "alwaysOn": true,

        "storageAccountName": "[concat(replace(variables('uniqueNameSuffix'), '-',''), 'sa')]",
        "blobServiceName": "default",
        "blobContainerName": "[concat('blob', variables('uniqueNameSuffix'))]",
        "storageAccountType": "[if(variables('isAppInProdMode'), 'Standard_RAGZRS', 'Standard_GRS')]",
        "storageAccountKind": "StorageV2",
        "accessTier": "Hot",
        "minimumTlsVersion": "TLS1_2",
        "supportsHttpsTrafficOnly": true,
        "allowSharedKeyAccess": false,
        "defaultToOAuthAuthentication": true,
        "storageAuthType": "msi",
        "networkAclsBypass": "AzureServices",
        "networkAclsDefaultAction": "Allow",
        "keySource": "Microsoft.Storage",
        "encryptionEnabled": true,
        "blobPublicAccessLevel": "[if(parameters('storageAccountPublicAccessEnabled'), 'blob', 'None')]",
        "deleteRetentionPolicy": {
            "enabled": true,
            "days": 7
        },
        "containerDeleteRetentionPolicy": {
            "enabled": true,
            "days": 7
        },

        "isPostgres": "[equals(parameters('databaseClient'), 'postgres')]",
        "databaseVersion":"[if(variables('isPostgres'), '16', '8.0.21')]",
        "databaseServiceName": "[if(variables('isPostgres'), 'Microsoft.DBforPostgreSQL/flexibleServers', 'Microsoft.DBforMySQL/flexibleServers')]",
        "databasePort": "[if(variables('isPostgres'), 5432, 3306)]",
        "databaseServerName": "[concat(variables('uniqueNameSuffix'), '-', parameters('databaseClient'), '-dbserver')]",
        "databaseName": "[concat('strapi_', variables('uniqueNameSuffix'), '_db')]",
        "databaseSsl": "true",
        "serverEdition": "[if(variables('isAppInProdMode'), 'GeneralPurpose', 'Burstable')]",
        "dbSkuName": "[if(variables('isAppInProdMode'), 'Standard_D2ds_v4', 'Standard_B1ms')]",
        "postgresStorageDiskType": "Premium_LRS",
        "postgresStorageDiskTier": "P10",
        "storageAutoIoScaling": "Enabled",
        "storageSizeGB": 32,
        "databasePublicNetworkAccess": "Disabled",
        "storageAutoGrow": "Enabled",
        "highAvailability": "[if(variables('isAppInProdMode'), 'ZoneRedundant', 'Disabled')]",
        "mySqlStorageRedundancy": "ZoneRedundancy",
        "backupRetentionDays": 7,
        "databaseCharset": "utf8",
        "databaseCollation": "[if(variables('isPostgres') ,'en_US.utf8', 'utf8_general_ci')]",  // use appropriate locale that matches your language and region needs
                
        "commServiceName": "[concat(variables('uniqueNameSuffix'), '-acsendpoint')]",
        "emailCommServiceName": "[concat(variables('uniqueNameSuffix'), '-emailacsendpoint')]",
        "emailDomainTitle": "AzureManagedDomain",
        "acsSenderName": "donotreply",
        "acsLocation": "global",
        "acsDomainManagement": "AzureManaged",
        "enableAcsEngagementTracking": "Disabled",

        "vnetName": "[concat(variables('uniqueNameSuffix'), '-vnet')]",
        "vnetAddressPrefix": "10.0.0.0/16",
        "appServiceSubnetName": "[concat(variables('uniqueNameSuffix'), '-appsubnet')]",
        "appServiceSubnetPrefix": "10.0.0.0/25",
        "databaseSubnetName": "[concat(variables('uniqueNameSuffix'), '-dbsubnet')]",
        "databaseSubnetPrefix": "10.0.1.0/25",
        
        "privateDomainSuffix": "[if(variables('isPostgres') , '.postgres.database.azure.com', '.mysql.database.azure.com')]",
        "privateDnsZoneName": "[concat(variables('uniqueNameSuffix'), '-privatelink', variables('privateDomainSuffix'))]",

        "managedIdentityName": "[concat(variables('uniqueNameSuffix'), '-sid')]",
        "customEmailContributorRoleId": "[guid(resourceGroup().name, variables('commServiceName'), 'CustomEmailContributorRole')]",
        "storageBlobContributorRoleId": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
 


        "vnetId": "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]",
        "appSubnetId": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('appServiceSubnetName'))]",
        "databaseSubnetId": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('databaseSubnetName'))]",
        "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneName'))]",
        "vnetLinkResourceId": "[resourceId('Microsoft.Network/privateDnsZones/virtualNetworkLinks', variables('privateDnsZoneName'), 'vnet-link')]",
        "managedIdentityResourceId": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('managedIdentityName'))]",
        "acsAccountId": "[resourceId('Microsoft.Communication/CommunicationServices', variables('commServiceName'))]",
        "ecsAccountId": "[resourceId('Microsoft.Communication/emailServices/domains', variables('emailCommServiceName'), variables('emailDomainTitle'))]",
        "databaseServerId": "[resourceId(variables('databaseServiceName'), variables('databaseServerName'))]",
        "storageAccountId": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]",
        "webAppResourceId": "[resourceId('Microsoft.Web/sites', parameters('appName'))]",



        "appServicesApiVersion": "2024-04-01",
        "storageAccountApiVersion": "2024-01-01",
        "databaseApiVersion": "[if(variables('isPostgres'), '2024-11-01-preview', '2023-12-30')]",
        "emailServiceApiVersion": "2023-04-01",
        "vnetDeploymentApiVersion": "2024-07-01",
        "privateDnsApiVersion": "2024-06-01",
        "managedIdentityApiVersion": "2024-11-30",
        "rbacAuthApiVersion": "2022-04-01",
        "resourceDeploymentApiVersion": "2024-11-01",
        "deploymentScriptsApiVersion": "2023-08-01"
    },
    "resources": [
        
        {
            "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
            "apiVersion": "[variables('managedIdentityApiVersion')]",
            "name": "[variables('managedIdentityName')]",
            "location": "[variables('location')]",
            "properties": {},
            "tags": "[variables('tags')]"
        },
        {
            "type": "Microsoft.Authorization/roleDefinitions",
            "apiVersion": "[variables('rbacAuthApiVersion')]",
            "name": "[variables('customEmailContributorRoleId')]",
            "properties": {
                "roleName": "[concat('Custom Email Contributor - ', uniqueString(resourceGroup().id))]",
                "description": "Custom Email Contributor role for Azure Communication Services",
                "assignableScopes": [
                    "[resourceGroup().id]"
                ],
                "permissions": [
                    {
                        "actions": [
                            "Microsoft.Communication/communicationServices/Read",
                            "Microsoft.Communication/communicationServices/Write"
                        ],
                        "notActions": [],
                        "dataActions": [],
                        "notDataActions": []
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Authorization/roleAssignments",
            "apiVersion": "[variables('rbacAuthApiVersion')]",
            "name": "[guid(variables('ecsAccountId'), variables('managedIdentityName'), 'CustomEmailContributor')]",
            "scope": "[variables('acsAccountId')]",
            "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions/', variables('customEmailContributorRoleId'))]",
                "principalId": "[reference(variables('managedIdentityResourceId'), variables('managedIdentityApiVersion')).principalId]",
                "principalType": "ServicePrincipal"
            },
            "dependsOn": [
                "[variables('managedIdentityResourceId')]",
                "[resourceId('Microsoft.Authorization/roleDefinitions', variables('customEmailContributorRoleId'))]",
                "[variables('acsAccountId')]"
            ]
        },
        {
            "type": "Microsoft.Authorization/roleAssignments",
            "apiVersion": "[variables('rbacAuthApiVersion')]", 
            "name": "[guid(variables('storageAccountId'), variables('managedIdentityName'), 'StorageBlobDataContributor')]",
            "scope": "[variables('storageAccountId')]",
            "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions/', variables('storageBlobContributorRoleId'))]",
                "principalId": "[reference(variables('managedIdentityResourceId'), variables('managedIdentityApiVersion')).principalId]",
                "principalType": "ServicePrincipal"
            },
            "dependsOn": [
                "[variables('managedIdentityResourceId')]",
                "[variables('storageAccountId')]"
            ]
        },

        {
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "[variables('vnetDeploymentApiVersion')]",
            "location": "[variables('location')]",
            "name": "[variables('vnetName')]",
            "tags": "[variables('tags')]",
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "[variables('vnetAddressPrefix')]"
                    ]
                },
                "subnets": []
            },
            "dependsOn": []
        },
        {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "[variables('vnetDeploymentApiVersion')]",
            "name": "[format('{0}/{1}', variables('vnetName'), variables('appServiceSubnetName'))]",
            "properties": {
                "addressPrefix": "[variables('appServiceSubnetPrefix')]",
                "delegations": [
                    {
                        "name": "dlg-appService",
                        "properties": {
                            "serviceName": "Microsoft.Web/serverFarms"
                        }
                    }
                ]
            },
            "dependsOn": [
                "[variables('vnetId')]"
            ]
        },
        {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "[variables('vnetDeploymentApiVersion')]",
            "name": "[format('{0}/{1}', variables('vnetName'), variables('databaseSubnetName'))]",
            "properties": {
                "addressPrefix": "[variables('databaseSubnetPrefix')]",
                "delegations": [
                    {
                        "name": "dlg-database",
                        "properties": {
                            "serviceName": "[variables('databaseServiceName')]"
                        }
                    }
                ]
            },
            "dependsOn": [
                "[variables('vnetId')]",
                "[variables('appSubnetId')]"

            ]
        },
        {
            "type": "Microsoft.Network/privateDnsZones",
            "apiVersion": "[variables('privateDnsApiVersion')]",
            "name": "[variables('privateDnsZoneName')]",
            "location": "global",
            "tags": "[variables('tags')]",
            "dependsOn": [
                "[variables('vnetId')]",
                "[variables('appSubnetId')]",
                "[variables('databaseSubnetId')]"
            ]
        },
        {
            "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
            "apiVersion": "[variables('privateDnsApiVersion')]",
            "name": "[format('{0}/{1}', variables('privateDnsZoneName'), 'vnet-link')]",
            "location": "global",
            "properties": {
                "virtualNetwork": {
                    "id": "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
                },
                "registrationEnabled": false
            },
            "dependsOn": [
                "[variables('privateDnsZoneId')]"
            ]
        },

        {
            "type": "Microsoft.Communication/emailServices",
            "apiVersion": "[variables('emailServiceApiVersion')]",
            "name": "[variables('emailCommServiceName')]",
            "location": "[variables('acsLocation')]",
            "tags": "[variables('tags')]",
            "properties": {
                "dataLocation": "[parameters('emailDataLocation')]"
            }
        },
        {
            "type": "Microsoft.Communication/communicationServices",
            "apiVersion": "[variables('emailServiceApiVersion')]",
            "name": "[variables('commServiceName')]",
            "location": "[variables('acsLocation')]",
            "tags": "[variables('tags')]",
            "properties": {
                "dataLocation": "[parameters('emailDataLocation')]",
                "linkedDomains": [
                    "[variables('ecsAccountId')]"
                ]
            },
            "dependsOn": [
                "[variables('ecsAccountId')]"
            ]
        },
        {
            "type": "Microsoft.Communication/emailServices/domains",
            "apiVersion": "[variables('emailServiceApiVersion')]",
            "name": "[concat(variables('emailCommServiceName'), '/', variables('emailDomainTitle'))]",
            "location": "[variables('acsLocation')]",
            "properties": {
                "domainManagement": "[variables('acsDomainManagement')]",
                "userEngagementTracking": "[variables('enableAcsEngagementTracking')]"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Communication/emailServices', variables('emailCommServiceName'))]"
            ]
        },
        {
            "type": "Microsoft.Communication/emailServices/domains/senderUsernames",
            "apiVersion": "[variables('emailServiceApiVersion')]",
            "name": "[concat(variables('emailCommServiceName'), '/', variables('emailDomainTitle'), '/', variables('acsSenderName'))]",
            "properties": {
                "displayName": "[variables('acsSenderName')]",
                "username": "[variables('acsSenderName')]"
            },
            "dependsOn": [
                "[variables('ecsAccountId')]"
            ]
        },

        {
            "condition": "[not(variables('isPostgres'))]",
            "type": "Microsoft.DBforMySQL/flexibleServers",
            "apiVersion": "[variables('databaseApiVersion')]",
            "name": "[variables('databaseServerName')]",
            "location": "[variables('location')]",
            "tags": "[variables('tags')]",
            "sku": {
                "name": "[variables('dbSkuName')]",
                "tier": "[variables('serverEdition')]"
            },
            "properties": {
                "createMode": "Default",
                "version": "[variables('databaseVersion')]",
                "administratorLogin": "[parameters('databaseAdminUsername')]",
                "administratorLoginPassword": "[parameters('databaseAdminPassword')]",
                "highAvailability": {
                    "mode": "[variables('highAvailability')]"
                },               
                "network": {
                    "publicNetworkAccess": "[variables('databasePublicNetworkAccess')]",
                    "DelegatedSubnetResourceId": "[variables('databaseSubnetId')]",
                    "PrivateDnsZoneResourceId": "[variables('privateDnsZoneId')]"
                },
                "storage": {
                    "autoGrow": "[variables('storageAutoGrow')]",
                    "storageSizeGB": "[variables('storageSizeGB')]",
                    "autoIoScaling": "[variables('storageAutoIoScaling')]",
                    "storageRedundancy": "[variables('mySqlStorageRedundancy')]"
                },
                "backup": {
                    "backupRetentionDays": "[variables('backupRetentionDays')]"
                }
            },
            "dependsOn": [
                "[variables('vnetLinkResourceId')]",
                "[variables('databaseSubnetId')]"
            ]
        },
        {
            "condition": "[not(variables('isPostgres'))]",
            "type": "Microsoft.DBforMySQL/flexibleServers/configurations",
            "apiVersion": "[variables('databaseApiVersion')]",
            "name": "[format('{0}/{1}', variables('databaseServerName'), 'sql_generate_invisible_primary_key')]",
            "properties": {
                "value": "OFF"
            },
            "dependsOn": [
                "[variables('databaseServerId')]"
            ]
        },
        {
            "condition": "[not(variables('isPostgres'))]",
            "type": "Microsoft.DBforMySQL/flexibleServers/databases",
            "name": "[format('{0}/{1}', variables('databaseServerName'), variables('databaseName'))]",
            "apiVersion": "[variables('databaseApiVersion')]",
            "properties": {
                "charset": "[variables('databaseCharset')]",
                "collation": "[variables('databaseCollation')]"
            },
            "dependsOn": [
                "[variables('databaseServerId')]"
            ]
        },

        {
            "condition": "[variables('isPostgres')]",
            "type": "Microsoft.DBforPostgreSQL/flexibleServers",
            "apiVersion": "[variables('databaseApiVersion')]",
            "name": "[variables('databaseServerName')]",
            "location": "[variables('location')]",
            "tags": "[variables('tags')]",
            "sku": {
                "name": "[variables('dbSkuName')]",
                "tier": "[variables('serverEdition')]"
            },
            "properties": {
                "createMode": "Default",
                "version": "[variables('databaseVersion')]",
                "administratorLogin": "[parameters('databaseAdminUsername')]",
                "administratorLoginPassword": "[parameters('databaseAdminPassword')]",
                "authConfig": {
                    "activeDirectoryAuth": "Disabled",
                    "passwordAuth": "Enabled"
                },
                "backup": {
                    "backupRetentionDays": "[variables('backupRetentionDays')]"
                },
                "highAvailability": {
                    "mode": "[variables('highAvailability')]"
                },
                "network": {
                    "publicNetworkAccess": "[variables('databasePublicNetworkAccess')]",
                    "delegatedSubnetResourceId": "[variables('databaseSubnetId')]",
                    "privateDnsZoneArmResourceId": "[variables('privateDnsZoneId')]"
                },
                "storage": {
                    "autoGrow": "[variables('storageAutoGrow')]",
                    "storageSizeGB": "[variables('storageSizeGB')]",
                    "tier": "[variables('postgresStorageDiskTier')]",
                    "type": "[variables('postgresStorageDiskType')]"
                }
            },
            "dependsOn": [
                "[variables('vnetLinkResourceId')]",
                "[variables('databaseSubnetId')]"
            ]
        },
        {
            "condition": "[variables('isPostgres')]",
            "type": "Microsoft.DBforPostgreSQL/flexibleServers/databases",
            "name": "[format('{0}/{1}', variables('databaseServerName'), variables('databaseName'))]",
            "apiVersion": "[variables('databaseApiVersion')]",
            "properties": {
                "charset": "[variables('databaseCharset')]",
                "collation": "[variables('databaseCollation')]"
            },
            "dependsOn": [
                "[variables('databaseServerId')]"
            ]
        },

        {
            "type": "Microsoft.Web/serverfarms",
            "apiVersion": "[variables('appServicesApiVersion')]",
            "name": "[variables('hostingPlanName')]",
            "location": "[variables('location')]",
            "tags": "[variables('tags')]",
            "properties": {
                "name": "[variables('hostingPlanName')]",
                "numberOfWorkers": "[variables('numberOfWorkers')]",
                "reserved": true
            },
            "sku": {
                "name": "[variables('skuName')]",
                "tier": "[variables('skuTier')]",
                "capacity": 1
            },
            "kind": "app,linux"
        },
        {
            "name": "[parameters('appName')]",
            "type": "Microsoft.Web/sites",
            "apiVersion": "[variables('appServicesApiVersion')]",
            "location": "[variables('location')]",
            "tags": "[variables('tags')]",
            "properties": {
                "name": "[parameters('appName')]",
                "serverFarmId": "[variables('serverFarmId')]",
                "httpsOnly": "true",
                "publicNetworkAccess": "[variables('publicNetworkAccess')]",
                "autoGeneratedDomainNameLabelScope": "[variables('autoGeneratedDomainNameLabelScope')]",
                "clientAffinityEnabled": false,
                "siteConfig": {
                    "linuxFxVersion": "[variables('linuxFxVersion')]",
                    "appCommandLine": "[variables('startupCommand')]",
                    "alwaysOn": "[variables('alwaysOn')]"
                }
            },
            "identity": {
                "type": "UserAssigned",
                "UserAssignedIdentities": {
                    "[variables('managedIdentityResourceId')]": {}
                }
            },
            "dependsOn": [
                "[variables('serverFarmId')]",
                "[resourceId(concat(variables('databaseServiceName'), '/databases'), variables('databaseServerName'), variables('databaseName'))]",
                "[variables('acsAccountId')]",
                "[variables('managedIdentityResourceId')]",
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices/containers', variables('storageAccountName'), 'default', variables('blobContainerName'))]"
            ]
        },
        {
             "type": "Microsoft.Resources/deployments",
             "apiVersion": "[variables('resourceDeploymentApiVersion')]",
             "name": "[format('{0}-{1}', parameters('appName'), 'appSettings')]",
             "properties": {
                 "mode": "Incremental",
                 "template": {
                     "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                     "contentVersion": "1.0.0.0",
                     "resources": [
                        {
                            "type": "Microsoft.Web/sites/networkConfig",
                            "name": "[format('{0}/{1}', parameters('appName'), 'virtualNetwork')]",
                            "apiVersion": "[variables('appServicesApiVersion')]",
                            "location": "[variables('location')]",
                            "properties": {
                                "subnetResourceId": "[variables('appSubnetId')]"
                            }
                        },
                        {
                            "type": "Microsoft.Web/sites/config",
                            "apiVersion": "[variables('appServicesApiVersion')]",
                            "name": "[concat(parameters('appName'), '/web')]",
                            "properties": {
                                "alwaysOn": "[variables('alwaysOn')]",
                                "appSettings": [
                                    {
                                        "name": "WEBSITES_CONTAINER_START_TIME_LIMIT",
                                        "value": "[variables('containerStartTimeLimit')]"
                                    },
                                    {
                                        "name": "SCM_DO_BUILD_DURING_DEPLOYMENT",
                                        "value": "[variables('scmDoBuildDuringDeployment')]"
                                    },
                                    {
                                        "name": "PORT",
                                        "value": "[variables('websitePort')]"
                                    },
                                    {
                                        "name": "NODE_ENV",
                                        "value": "[parameters('applicationMode')]"
                                    },
                                    {
                                        "name": "ENTRA_CLIENT_ID",
                                        "value": "[reference(variables('managedIdentityResourceId'), variables('managedIdentityApiVersion')).clientId]"
                                    },
                                    {
                                        "name": "DATABASE_CLIENT",
                                        "value": "[parameters('databaseClient')]"
                                    },
                                    {
                                        "name": "DATABASE_HOST",
                                        "value": "[reference(resourceId(variables('databaseServiceName'), variables('databaseServerName')), variables('databaseApiVersion')).fullyQualifiedDomainName]"
                                    },
                                    {
                                        "name": "DATABASE_PORT",
                                        "value": "[variables('databasePort')]"
                                    },
                                    {
                                        "name": "DATABASE_NAME",
                                        "value": "[variables('databaseName')]"
                                    },
                                    {
                                        "name": "DATABASE_USERNAME",
                                        "value": "[parameters('databaseAdminUsername')]"
                                    },
                                    {
                                        "name": "DATABASE_PASSWORD",
                                        "value": "[parameters('databaseAdminPassword')]"
                                    },
                                    {
                                        "name": "DATABASE_SSL",
                                        "value": "[variables('databaseSsl')]"
                                    },
                                    {
                                        "name": "STORAGE_AUTH_TYPE",
                                        "value": "[variables('storageAuthType')]"
                                    },
                                    {
                                        "name": "STORAGE_ACCOUNT_NAME",
                                        "value": "[variables('storageAccountName')]"
                                    },
                                    {
                                        "name": "BLOB_CONTAINER_NAME",
                                        "value": "[variables('blobContainerName')]"
                                    },
                                    {
                                        "name": "BLOB_STORAGE_URL",
                                        "value": "[reference(variables('storageAccountId'), variables('storageAccountApiVersion')).primaryEndpoints.blob]"
                                    },
                                    {
                                        "name": "APP_KEYS",
                                        "value": "[parameters('appKeys')]"
                                    },
                                    {
                                        "name": "ADMIN_JWT_SECRET",
                                        "value": "[parameters('adminJwtSecret')]"
                                    },
                                    {
                                        "name": "JWT_SECRET",
                                        "value": "[parameters('jwtSecret')]"
                                    },
                                    {
                                        "name": "API_TOKEN_SALT",
                                        "value": "[parameters('apiTokenSalt')]"
                                    },
                                    {
                                        "name": "TRANSFER_TOKEN_SALT",
                                        "value": "[parameters('transferTokenSalt')]"
                                    },
                                    {
                                        "name": "AZURE_EMAIL_SERVICE_ENDPOINT",
                                        "value": "[concat('https://', reference(variables('acsAccountId')).hostName, '/')]"
                                    },
                                    {
                                        "name": "FROM_EMAIL",
                                        "value": "[concat( variables('acsSenderName'),'@',reference(variables('ecsAccountId')).mailFromSenderDomain)]"
                                    }
                                ]
                            },
                            "dependsOn": [
                                "[resourceId('Microsoft.Web/sites/networkConfig', parameters('appName'), 'virtualNetwork')]"
                            ]
                        }
                     ]
                }
             },
            "dependsOn": [
                "[variables('webAppResourceId')]",
                "[variables('vnetLinkResourceId')]"
            ]
        },
        {
             "type": "Microsoft.Resources/deployments",
             "apiVersion": "[variables('resourceDeploymentApiVersion')]",
             "name": "[format('{0}-{1}', parameters('appName'), 'bpcpConfigurations')]",
             "properties": {
                 "mode": "Incremental",
                 "template": {
                     "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                     "contentVersion": "1.0.0.0",
                     "resources": [
                        {
                            "type": "Microsoft.Web/sites/basicPublishingCredentialsPolicies",
                            "name": "[concat(parameters('appName'), '/scm')]",
                            "apiVersion": "[variables('appServicesApiVersion')]",
                            "properties": {
                                "allow": "false"
                            }
                        },
                        {
                            "type": "Microsoft.Web/sites/basicPublishingCredentialsPolicies",
                            "name": "[concat(parameters('appName'), '/ftp')]",
                            "apiVersion": "[variables('appServicesApiVersion')]",
                            "properties": {
                                "allow": "false"
                            }
                        }
                     ]
                }
             },
            "dependsOn": [
                "[variables('webAppResourceId')]"
            ]
        },
        {
            "condition": "[not(variables('isAppInProdMode'))]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('resourceDeploymentApiVersion')]",
            "name": "[format('{0}-{1}', parameters('appName'), 'oneDeploy')]",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "resources": [
                        // This is a dummy script to delay the package deployment by 30s to ensure the SCM container is up and running to handle the deployment
                        {
                            "type": "Microsoft.Resources/deploymentScripts",
                            "apiVersion": "[variables('deploymentScriptsApiVersion')]",
                            "name": "[format('{0}-{1}', parameters('appName'), 'deployDelayScript')]",
                            "location": "[variables('location')]",
                            "kind": "AzurePowerShell",
                            "identity": {
                                "type": "UserAssigned",
                                "userAssignedIdentities": {
                                    "[variables('managedIdentityResourceId')]": {}
                                }
                            },
                            "properties": {
                                "azPowerShellVersion": "13.2",
                                "scriptContent": "Start-Sleep -Seconds 30",
                                "cleanupPreference": "Always",
                                "retentionInterval": "PT1H",
                                "timeout": "PT5M"
                            }
                        },
                        {
                            "type": "Microsoft.Web/sites/extensions",
                            "name": "[format('{0}/{1}', parameters('appName'), 'onedeploy')]",
                            "apiVersion": "[variables('appServicesApiVersion')]",
                            "location": "[variables('location')]",
                            "properties": {
                                "type": "zip",
                                "packageUri": "[variables('artifactLocation')]"
                            },
                            "dependsOn": [
                                "[resourceId('Microsoft.Resources/deploymentScripts', format('{0}-{1}', parameters('appName'), 'deployDelayScript'))]"
                            ]
                        }
                    ]
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('{0}-{1}', parameters('appName'), 'appSettings'))]",
                "[resourceId('Microsoft.Resources/deployments', format('{0}-{1}', parameters('appName'), 'bpcpConfigurations'))]",
                "[variables('managedIdentityResourceId')]"
            ]
        },

        {
            "name": "[variables('storageAccountName')]",
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "[variables('storageAccountApiVersion')]",
            "location": "[variables('location')]",
            "properties": {
                "accessTier": "[variables('accessTier')]",
                "minimumTlsVersion": "[variables('minimumTlsVersion')]",
                "supportsHttpsTrafficOnly": "[variables('supportsHttpsTrafficOnly')]",
                "allowBlobPublicAccess": "[parameters('storageAccountPublicAccessEnabled')]",
                "allowSharedKeyAccess": "[variables('allowSharedKeyAccess')]",
                "defaultToOAuthAuthentication": "[variables('defaultToOAuthAuthentication')]",
                "networkAcls": {
                    "bypass": "[variables('networkAclsBypass')]",
                    "defaultAction": "[variables('networkAclsDefaultAction')]",
                    "ipRules": []
                },
                "encryption": {
                    "keySource": "[variables('keySource')]",
                    "services": {
                        "blob": {
                            "enabled": "[variables('encryptionEnabled')]"
                        },
                        "file": {
                            "enabled": "[variables('encryptionEnabled')]"
                        },
                        "table": {
                            "enabled": "[variables('encryptionEnabled')]"
                        },
                        "queue": {
                            "enabled": "[variables('encryptionEnabled')]"
                        }
                    }
                }
            },
            "kind": "[variables('storageAccountKind')]",
            "tags": "[variables('tags')]",
            "sku": {
                "name": "[variables('storageAccountType')]"
            }
        },
        {
            "name": "[format('{0}/{1}', variables('storageAccountName'), variables('blobServiceName'))]",
            "type": "Microsoft.Storage/storageAccounts/blobServices",
            "apiVersion": "[variables('storageAccountApiVersion')]",
            "properties": {
                "deleteRetentionPolicy": {
                    "enabled": "[variables('deleteRetentionPolicy').enabled]",
                    "days": "[variables('deleteRetentionPolicy').days]"
                },
                "containerDeleteRetentionPolicy": {
                    "enabled": "[variables('containerDeleteRetentionPolicy').enabled]",
                    "days": "[variables('containerDeleteRetentionPolicy').days]"
                }
            },
            "dependsOn": [
                "[variables('storageAccountId')]"
            ]
        },
        {
            "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
            "apiVersion": "[variables('storageAccountApiVersion')]",
            "name": "[format('{0}/{1}/{2}', variables('storageAccountName'), variables('blobServiceName'), variables('blobContainerName'))]",
            "properties": {
                "publicAccess": "[variables('blobPublicAccessLevel')]"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageAccountName'), variables('blobServiceName'))]"
            ]
        }
    ]
}
